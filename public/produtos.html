<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pe√ßas ‚Äî Milton Motos e Pe√ßas</title>
  <meta name="description" content="Gest√£o de pe√ßas integrada ao backend" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--brand-red:#C62828;--brand-blue:#0D47A1;--brand-white:#fff;--bg:#0d1220;--panel:#0f1628;--panel-2:#0b1220;--muted:#94a3b8;--text:#e5e7eb;--danger:#ef4444;--ring:0 0 0 3px rgba(13,71,161,.35);--shadow-lg:0 18px 40px rgba(0,0,0,.45);--shadow-md:0 10px 24px rgba(0,0,0,.35);--radius:18px}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 600px at 80% -10%,rgba(13,71,161,.25),transparent 40%),radial-gradient(1000px 500px at -10% 20%,rgba(198,40,40,.2),transparent 45%),var(--bg);color:var(--text);line-height:1.45;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    a{color:inherit;text-decoration:none}
    button{font:inherit}

    .app{display:grid;grid-template-rows:auto 1fr;min-height:100dvh}
    .header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(16,24,39,.9),rgba(16,24,39,.7));backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06)}
    .header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:14px 20px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.2px}
    .logo{width:42px;height:42px;border-radius:14px;overflow:hidden;display:grid;place-items:center;background:linear-gradient(135deg,#c62828,#0d47a1);box-shadow:var(--shadow-md)}
    .brand-title{font-size:clamp(16px,2vw,20px)}
    .nav{margin-left:auto;display:flex;align-items:center;gap:8px}
    .nav a{padding:10px 14px;border-radius:10px;color:#cbd5e1}
    .nav a.active,.nav a:hover{color:#fff;background:rgba(255,255,255,.06)}

    .container{max-width:1200px;margin:0 auto;padding:24px 20px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.06);box-shadow:var(--shadow-lg);border-radius:var(--radius);padding:18px}

    .toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .search{display:flex;align-items:center;gap:10px;flex:1;min-width:280px;background:#0b1324;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px}
    .search input{flex:1;background:transparent;border:0;outline:0;color:var(--text)}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:linear-gradient(135deg,#0d47a1,#0a3a86);color:#fff;box-shadow:var(--shadow-md)}
    .btn-ghost{background:transparent;color:var(--text)}
    .btn-danger{background:linear-gradient(135deg,#ef4444,#c81e1e);color:#fff}

    .table-wrap{overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02)}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:760px}
    thead th{position:sticky;top:0;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));text-align:left;padding:14px 12px;font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:#a6b4c7}
    tbody td{padding:16px 12px;border-top:1px solid rgba(255,255,255,.06)}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12)}
    .badge.blue{background:rgba(13,71,161,.12)}.badge.red{background:rgba(198,40,40,.12)}

    .footer{color:#9fb0c7;text-align:center;padding:26px 16px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;padding:16px;z-index:60}
    .modal{width:100%;max-width:560px;background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:var(--shadow-lg)}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.06)}
    .modal .body{padding:18px;display:grid;gap:12px}
    .modal .footer{display:flex;justify-content:flex-end;gap:10px;padding:16px 18px;border-top:1px solid rgba(255,255,255,.06)}
    .field{display:grid;gap:6px}
    .field label{font-size:13px;color:#a6b4c7}
    .field input,.field select,.field textarea{background:#0b1324;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px 12px;color:var(--text)}

    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:70}
    .toast .msg{background:var(--panel);border:1px solid rgba(255,255,255,.08);padding:12px 14px;border-radius:12px}
  </style>
</head>
<body>
<script>
  // Guard simples: precisa estar logado
  (function(){ const u = localStorage.getItem('usuario'); if(!u){ location.href = 'login-cadastro.html'; }})();
</script>
<div class="app">
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="#fff" aria-hidden="true"><path d="M5 17h14l-1 3H6l-1-3Zm13.5-4c.83 0 1.5.67 1.5 1.5S19.33 16 18.5 16 17 15.33 17 14.5s.67-1.5 1.5-1.5ZM5.5 13c.83 0 1.5.67 1.5 1.5S6.33 16 5.5 16 4 15.33 4 14.5 4.67 13 5.5 13ZM3 6h9l3 3h6v5H3V6Z"/></svg>
        </div>
        <span class="brand-title">Milton Motos e Pe√ßas</span>
      </div>
      <nav class="nav" aria-label="Navega√ß√£o principal">
        <a href="dashboard.html">Dashboard</a>
        <a href="#" class="active">Pe√ßas</a>
        <a href="vendas.html">Vendas</a>
        <a href="estoque.html">Estoque</a>
        <a href="#" id="btnLogout" class="btn btn-ghost">‚éã Sair</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <article class="card" style="margin-bottom:12px">
      <h1 style="margin:8px 0 6px;font-size:clamp(22px,3.2vw,30px)">Pe√ßas</h1>
      <p style="color:#cbd5e1;margin:0">Gerencie o cat√°logo, ajuste estoques e mantenha os pre√ßos atualizados.</p>
    </article>

    <section class="toolbar">
      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23 6.5 6.5 0 1 0-6.5 6.5 6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5Zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14Z"/></svg>
        <input id="busca" type="search" placeholder="Buscar pe√ßa por nome, tipo ou c√≥digo..." aria-label="Buscar pe√ßa">
      </div>
      <div style="display:flex;gap:10px">
        <button class="btn btn-primary" id="btnAdd">‚ûï Adicionar</button>
        <button class="btn btn-ghost" id="btnAtualizar">Atualizar</button>
        <button class="btn btn-ghost" id="btnExportar">Exportar CSV</button>
      </div>
    </section>

    <section class="table-wrap" role="region" aria-label="Pe√ßas">
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nome</th>
            <th>Tipo</th>
            <th>Pre√ßo</th>
            <th>Estoque</th>
            <th>Status</th>
            <th style="text-align:right">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tbody-pecas"></tbody>
      </table>
    </section>
  </main>

  <footer class="footer">¬© <span id="ano"></span> Milton Motos e Pe√ßas ‚Äî Todos os direitos reservados.</footer>
</div>

<!-- MODAL: Add/Edit Pe√ßa -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <header>
      <h3 id="modalTitle" style="margin:0">Adicionar pe√ßa</h3>
      <button class="btn btn-ghost" id="btnCloseModal" aria-label="Fechar">‚úñ</button>
    </header>
    <form id="formPeca">
      <div class="body">
        <div class="field"><label for="codigo">C√≥digo</label><input id="codigo" name="codigo" type="text" placeholder="Ex: MM-0001"></div>
        <div class="field"><label for="nome">Nome</label><input id="nome" name="nome" type="text" required placeholder="Ex: Filtro de √ìleo"></div>
        <div class="field"><label for="tipo">Tipo</label>
          <select id="tipo" name="tipo" required>
            <option value="">Selecione...</option>
            <option>Motor</option>
            <option>Freio</option>
            <option>Suspens√£o</option>
            <option>El√©trica</option>
            <option>Carroceria</option>
          </select>
        </div>
        <div class="field"><label for="descricao">Descri√ß√£o</label><textarea id="descricao" name="descricao" rows="3" placeholder="Detalhes da pe√ßa"></textarea></div>
        <div class="field"><label for="preco">Pre√ßo</label><input id="preco" name="preco" type="number" step="0.01" min="0" required placeholder="0,00"></div>
        <div class="field"><label for="estoque">Estoque</label><input id="estoque" name="estoque" type="number" min="0" required placeholder="0"></div>
        <input type="hidden" id="pecaId" name="pecaId" />
      </div>
      <div class="footer">
        <button type="button" class="btn btn-ghost" id="btnCancel">Cancelar</button>
        <button type="submit" class="btn btn-primary" id="btnSalvar">Salvar</button>
      </div>
    </form>
  </div>
</div>

<div class="toast" id="toast" aria-live="polite"></div>

<script>
  // ====== CONFIG ======
  const API_BASE = 'http://localhost:5000';
  const API_PRODUTOS = API_BASE + '/api/produtos';
  const API_CADASTRO = API_BASE + '/api/produtos';
  const token = localStorage.getItem('token');
  const auth = token ? { 'Authorization': 'Bearer ' + token } : {};

  // ====== ELEMENTOS ======
  const ano = document.getElementById('ano'); ano.textContent = new Date().getFullYear();
  const tbody = document.getElementById('tbody-pecas');
  const busca = document.getElementById('busca');
  const btnAdd = document.getElementById('btnAdd');
  const btnAtualizar = document.getElementById('btnAtualizar');
  const btnExportar = document.getElementById('btnExportar');
  const btnLogout = document.getElementById('btnLogout');

  // ====== EVENTOS ======
  busca.addEventListener('input', handleSearch);
  btnAtualizar.addEventListener('click', loadPecas);
  btnExportar.addEventListener('click', exportCSV);
  btnAdd.addEventListener('click', ()=> openModal());
  btnLogout.addEventListener('click', ()=>{ localStorage.clear(); location.href='login-cadastro.html'; });

  // ====== CRUD ======
  async function loadPecas(){
    try{
      const res = await fetch(API_PRODUTOS, { headers: { ...auth } });
      const data = await res.json();
      const pecas = Array.isArray(data) ? data : (data.produtos || []);
      renderPecas(pecas);
    }catch(err){ toast('N√£o foi poss√≠vel carregar as pe√ßas. Verifique a API.', true); console.error(err); }
  }

  function renderPecas(pecas){
    const frag = document.createDocumentFragment();
    pecas.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = (
        '<td>'+ (p.codigo||'') +'</td>'+
        '<td>'+ (p.nome||'') +'</td>'+
        '<td><span class="badge '+ (p.tipo==='Freio'?'red':'blue') +'">'+ (p.tipo||'') +'</span></td>'+
        '<td>'+ fmtBRL(p.preco) +'</td>'+
        '<td>'+ (p.estoque ?? 0) +'</td>'+
        '<td><span class="badge">'+ ((p.estoque ?? 0) <= 10 ? 'Baixo' : 'Dispon√≠vel') +'</span></td>'+
        '<td style="text-align:right; display:flex; gap:6px; justify-content:flex-end">\
          <button class="btn btn-ghost" title="Editar">‚úèÔ∏è</button>\
          <button class="btn btn-danger" title="Excluir">üóëÔ∏è</button>\
        </td>'
      );
      const [btnEditar, btnExcluir] = tr.querySelectorAll('button');
      btnEditar.addEventListener('click', ()=> openModal('edit', p));
      btnExcluir.addEventListener('click', ()=> deletePeca(p));
      frag.appendChild(tr);
    });
    tbody.replaceChildren(frag);
  }

  async function savePeca(payload, id){
    const url = id ? (API_PRODUTOS + '/' + id) : API_CADASTRO;
    const method = id ? 'PUT' : 'POST';
    const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json', ...auth }, body: JSON.stringify(payload) });
    const json = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(json.error || json.message || 'Falha ao salvar');
    return json;
  }

  async function deletePeca(peca){
    if(!peca || !peca._id){ return toast('ID da pe√ßa ausente.', true); }
    if(!confirm('Excluir "'+ (peca.nome||'pe√ßa') +'"?')) return;
    const res = await fetch(API_PRODUTOS + '/' + peca._id, { method:'DELETE', headers:{ ...auth } });
    const json = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(json.error || json.message || 'Falha ao excluir');
    toast('Pe√ßa exclu√≠da.');
    loadPecas();
  }

  // ====== Modal ======
  const modalBackdrop = document.getElementById('modalBackdrop');
  const btnCloseModal = document.getElementById('btnCloseModal');
  const btnCancel = document.getElementById('btnCancel');
  const formPeca = document.getElementById('formPeca');
  const modalTitle = document.getElementById('modalTitle');

  function openModal(mode='add', data=null){
    modalTitle.textContent = (mode==='edit') ? 'Editar pe√ßa' : 'Adicionar pe√ßa';
    formPeca.reset();
    document.getElementById('pecaId').value = data ? (data._id||'') : '';
    document.getElementById('codigo').value = data?.codigo || '';
    document.getElementById('nome').value = data?.nome || '';
    document.getElementById('tipo').value = data?.tipo || '';
    document.getElementById('descricao').value = data?.descricao || '';
    document.getElementById('preco').value = data?.preco || '';
    document.getElementById('estoque').value = data?.estoque || '';
    modalBackdrop.style.display = 'flex';
  }
  function closeModal(){ modalBackdrop.style.display = 'none'; }
  btnCloseModal.addEventListener('click', closeModal);
  btnCancel.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });

  formPeca.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      codigo: formPeca.codigo.value.trim() || undefined,
      nome: formPeca.nome.value.trim(),
      tipo: formPeca.tipo.value,
      descricao: formPeca.descricao.value.trim(),
      preco: Number(formPeca.preco.value),
      estoque: Number(formPeca.estoque.value)
    };
    const id = document.getElementById('pecaId').value.trim();
    try{
      await savePeca(payload, id);
      toast(id ? 'Pe√ßa atualizada!' : 'Pe√ßa adicionada!');
      closeModal();
      loadPecas();
    }catch(err){ toast('Erro: ' + err.message, true); }
  });

  // ====== Utils ======
  function handleSearch(){
    const termo = (busca.value||'').toLowerCase();
    for(const tr of tbody.querySelectorAll('tr')){
      tr.style.display = tr.textContent.toLowerCase().includes(termo) ? '' : 'none';
    }
  }
  function exportCSV(){
    const linhas = [...document.querySelectorAll('table tr')]
      .map(tr => [...tr.children].map(td => '"' + td.textContent.replace(/"/g,'""') + '"').join(','));
    const blob = new Blob([linhas.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:'pecas.csv'});
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function fmtBRL(v){ const n = Number(v||0); return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
  function toast(msg,isErr=false){ const box=document.getElementById('toast'); const el=document.createElement('div'); el.className='msg'; el.style.borderColor = isErr ? 'rgba(239,68,68,.4)' : 'rgba(16,185,129,.4)'; el.textContent=msg; box.appendChild(el); setTimeout(()=>{el.remove()},3500); }

  // Start
  loadPecas();
</script>
</body>
</html>
