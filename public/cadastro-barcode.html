<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Milton Motos e Pe√ßas ‚Äî Cadastro com C√≥digo de Barras</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand-red: #C62828;
      --brand-blue: #0D47A1;
      --brand-white: #ffffff;
      --bg: #0f172a;
      --panel: #111827;
      --panel-2: #0b1220;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --ok: #16a34a;
      --warn: #f59e0b;
      --danger: #ef4444;
      --ring: 0 0 0 3px rgba(13,71,161,.3);
      --shadow-lg: 0 10px 30px rgba(0,0,0,.35);
      --shadow-md: 0 6px 18px rgba(0,0,0,.25);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-xl: 24px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 80% -10%, rgba(13,71,161,.25), transparent 40%),
                  radial-gradient(1000px 500px at -10% 20%, rgba(198,40,40,.25), transparent 45%),
                  var(--bg);
      color: var(--text);
      line-height:1.45;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a{color:inherit;text-decoration:none}
    button{font:inherit;cursor:pointer}

    .app{display:grid;grid-template-rows: auto 1fr;min-height:100dvh}

    /* Header igual ao seu sistema */
    .header{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(180deg, rgba(17,24,39,.9), rgba(17,24,39,.75));
      backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .header-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; gap:16px;
      padding:14px 20px;
    }
    .brand{display:flex; align-items:center; gap:12px;font-weight:700; letter-spacing:.3px}
    .logo{
      width:40px; height:40px; border-radius:12px; overflow:hidden;
      display:grid; place-items:center;
      background: linear-gradient(135deg, var(--brand-red), var(--brand-blue));
      box-shadow: var(--shadow-md);
    }
    .brand-title{font-size: clamp(16px, 2vw, 20px)}

    .nav{margin-left:auto; display:flex; align-items:center; gap:8px}
    .nav a{padding:10px 14px; border-radius:10px; color: var(--muted);transition: all 0.2s ease}
    .nav a.active, .nav a:hover{color:var(--brand-white); background: rgba(255,255,255,.06)}

    .btn{cursor:pointer; border:0; border-radius:12px; padding:10px 14px; display:inline-flex; align-items:center; gap:8px; transition: all 0.2s ease}
    .btn-primary{background: linear-gradient(135deg, var(--brand-blue), #0b3c86); color:#fff; box-shadow: var(--shadow-md)}
    .btn-primary:hover{filter:brightness(1.05); transform: translateY(-1px)}
    .btn-ghost{background: transparent; color: var(--text)}
    .btn-ghost:hover{background: rgba(255,255,255,.06)}
    .btn-success{background: linear-gradient(135deg, var(--ok), #15803d); color:#fff; box-shadow: var(--shadow-md)}
    .btn-danger{background: linear-gradient(135deg, var(--danger), #dc2626); color:#fff; box-shadow: var(--shadow-md)}

    .container{max-width:1000px; margin:0 auto; padding:24px 20px}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow-lg);
      border-radius: var(--radius);
      padding:24px;
      margin-bottom:24px;
    }

    .hero{
      background: radial-gradient(800px 300px at 20% -30%, rgba(13,71,161,.25), transparent 40%),
                  radial-gradient(600px 260px at 100% 120%, rgba(198,40,40,.22), transparent 55%),
                  linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      text-align:center;
    }
    .hero h1{
      margin:8px 0 12px; font-size: clamp(24px, 3.4vw, 36px);
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-red));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .scanner-section{
      background: var(--panel-2);
      border:2px dashed rgba(255,255,255,.2);
      border-radius: var(--radius);
      padding:40px 24px;
      text-align:center;
      margin-bottom:30px;
      transition: all 0.3s ease;
    }
    .scanner-section.active{
      border-color: var(--brand-blue);
      background: rgba(13,71,161,.1);
      box-shadow: 0 0 30px rgba(13,71,161,.2);
    }

    .scanner-icon{
      font-size:4rem;
      margin-bottom:16px;
      opacity:0.8;
    }

    .barcode-input{
      width:100%;
      max-width:400px;
      padding:16px 20px;
      font-size:18px;
      font-family: 'Courier New', monospace;
      background: var(--panel);
      border:2px solid rgba(255,255,255,.1);
      border-radius:12px;
      color: var(--text);
      text-align:center;
      letter-spacing:1px;
      margin:16px auto;
      display:block;
      transition: all 0.3s ease;
    }
    .barcode-input:focus{
      outline:0;
      border-color: var(--brand-blue);
      box-shadow: var(--ring);
    }
    .barcode-input.success{
      border-color: var(--ok);
      background: rgba(22,163,74,.1);
    }
    .barcode-input.error{
      border-color: var(--danger);
      background: rgba(239,68,68,.1);
    }

    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
      gap:20px;
      margin:24px 0;
    }
    .form-group{display:flex; flex-direction:column; gap:8px}
    .form-group label{
      font-size:12px; color:var(--muted); text-transform:uppercase;
      letter-spacing:.08em; font-weight:600;
    }
    .form-group input, .form-group select, .form-group textarea{
      padding:12px 16px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:10px;
      background:var(--panel-2);
      color:var(--text);
      transition: all 0.2s ease;
      font-size:14px;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus{
      outline:0;
      border-color:var(--brand-blue);
      box-shadow: var(--ring);
    }
    .form-group textarea{resize:vertical; min-height:80px}

    .alert{
      padding:16px 20px;
      border-radius:12px;
      margin:16px 0;
      display:flex;
      align-items:center;
      gap:12px;
      font-weight:500;
    }
    .alert-success{background:rgba(22,163,74,.15); border:1px solid rgba(22,163,74,.3); color:var(--ok)}
    .alert-warning{background:rgba(245,158,11,.15); border:1px solid rgba(245,158,11,.3); color:var(--warn)}
    .alert-danger{background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.3); color:var(--danger)}
    .alert-info{background:rgba(13,71,161,.15); border:1px solid rgba(13,71,161,.3); color:var(--brand-blue)}

    .product-preview{
      background: var(--panel);
      border:1px solid rgba(255,255,255,.1);
      border-radius:12px;
      padding:20px;
      margin:20px 0;
      display:none;
    }
    .product-preview.show{display:block; animation: fadeIn 0.3s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    .product-preview h3{
      margin:0 0 16px;
      color:var(--brand-blue);
      display:flex;
      align-items:center;
      gap:8px;
    }

    .preview-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:16px;
    }
    .preview-item{
      padding:12px;
      background:var(--panel-2);
      border-radius:8px;
      border-left:3px solid var(--brand-blue);
    }
    .preview-item .label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.05em;
      margin-bottom:4px;
    }
    .preview-item .value{
      font-weight:600;
      color:var(--text);
    }

    .actions{
      display:flex;
      gap:16px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:30px;
    }

    .loading{
      display:none;
      justify-content:center;
      align-items:center;
      gap:12px;
      padding:20px;
      color:var(--muted);
    }
    .loading.show{display:flex}

    .spinner{
      width:20px;
      height:20px;
      border:2px solid rgba(255,255,255,.1);
      border-top:2px solid var(--brand-blue);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    @media (max-width:640px){
      .container{padding:16px}
      .hero h1{font-size:24px}
      .scanner-section{padding:30px 16px}
      .barcode-input{font-size:16px}
      .actions{flex-direction:column}
      .form-grid{grid-template-columns:1fr}
    }

    /* Estilos para c√¢mera/scanner */
    .camera-section{
      background: var(--panel);
      border-radius:12px;
      padding:20px;
      text-align:center;
      margin:20px 0;
      display:none;
    }
    .camera-section.show{display:block}

    #video{
      width:100%;
      max-width:400px;
      border-radius:8px;
      border:2px solid var(--brand-blue);
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="#fff" aria-hidden="true">
            <path d="M5 17h14l-1 3H6l-1-3Zm13.5-4c.83 0 1.5.67 1.5 1.5S19.33 16 18.5 16 17 15.33 17 14.5s.67-1.5 1.5-1.5ZM5.5 13c.83 0 1.5.67 1.5 1.5S6.33 16 5.5 16 4 15.33 4 14.5 4.67 13 5.5 13ZM3 6h9l3 3h6v5H3V6Z"/>
          </svg>
        </div>
        <span class="brand-title">Milton Motos e Pe√ßas</span>
      </div>

      <nav class="nav" aria-label="Navega√ß√£o principal">
        <a href="/">Dashboard</a>
        <a href="/produtos.html">Pe√ßas</a>
        <a href="/vendas.html">Vendas</a>
        <a href="/estoque.html">Estoque</a>
        <button class="btn btn-ghost" title="Sair" aria-label="Sair">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M16 13v-2H7V8l-5 4 5 4v-3h9Z"/>
            <path d="M20 3h-8v2h8v14h-8v2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2Z"/>
          </svg>
          Sair
        </button>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="container">
    <!-- Hero -->
    <section class="card hero">
      <h1>üì¶ Cadastro de Produto com C√≥digo de Barras</h1>
      <p>Escaneie ou digite o c√≥digo de barras para cadastrar automaticamente uma nova pe√ßa no estoque</p>
    </section>

    <!-- Scanner Section -->
    <section class="card">
      <div class="scanner-section" id="scannerSection">
        <div class="scanner-icon">üì±</div>
        <h3 style="margin:0 0 12px; color:var(--text)">Escaneie o C√≥digo de Barras</h3>
        <p style="color:var(--muted); margin-bottom:20px">
          Posicione o c√≥digo de barras em frente √† c√¢mera ou digite manualmente
        </p>
        
        <input 
          type="text" 
          id="barcodeInput" 
          class="barcode-input" 
          placeholder="Digite ou escaneie o c√≥digo de barras..."
          autocomplete="off"
          maxlength="20"
        >
        
        <div style="display:flex; gap:12px; justify-content:center; margin-top:16px">
          <button class="btn btn-primary" onclick="startCamera()">
            üì∑ Usar C√¢mera
          </button>
          <button class="btn btn-ghost" onclick="processBarcode()">
            ‚å®Ô∏è Digitar C√≥digo
          </button>
          <button class="btn btn-ghost" onclick="clearForm()">
            üîÑ Limpar
          </button>
        </div>
      </div>

      <!-- Camera Section -->
      <div class="camera-section" id="cameraSection">
        <h4 style="margin:0 0 16px">üì∑ Scanner de C√≥digo de Barras</h4>
        <video id="video" autoplay></video>
        <canvas id="canvas" style="display:none"></canvas>
        <div style="margin-top:16px">
          <button class="btn btn-danger" onclick="stopCamera()">
            ‚èπÔ∏è Parar C√¢mera
          </button>
        </div>
      </div>

      <!-- Loading -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <span>Processando c√≥digo de barras...</span>
      </div>

      <!-- Alerts -->
      <div id="alertContainer"></div>
    </section>

    <!-- Product Form -->
    <section class="card">
      <h2 style="margin:0 0 20px; color:var(--text)">üìù Dados do Produto</h2>
      
      <form id="productForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="codigoProduto">C√≥digo da Pe√ßa *</label>
            <input type="text" id="codigoProduto" required placeholder="MM-0001">
          </div>
          <div class="form-group">
            <label for="nomeProduto">Nome do Produto *</label>
            <input type="text" id="nomeProduto" required placeholder="Ex: Filtro de √ìleo Honda">
          </div>
          <div class="form-group">
            <label for="tipoProduto">Tipo da Pe√ßa *</label>
            <select id="tipoProduto" required>
              <option value="">Selecione o tipo...</option>
              <option value="Motor">Motor</option>
              <option value="Freio">Freio</option>
              <option value="Suspensao">Suspens√£o</option>
              <option value="Eletrica">El√©trica</option>
              <option value="Carroceria">Carroceria</option>
              <option value="Transmissao">Transmiss√£o</option>
              <option value="Outros">Outros</option>
            </select>
          </div>
          <div class="form-group">
            <label for="precoProduto">Pre√ßo (R$) *</label>
            <input type="number" id="precoProduto" required step="0.01" min="0" placeholder="29,90">
          </div>
          <div class="form-group">
            <label for="quantidadeProduto">Quantidade Inicial *</label>
            <input type="number" id="quantidadeProduto" required min="0" placeholder="50">
          </div>
          <div class="form-group">
            <label for="estoqueMinimo">Estoque M√≠nimo</label>
            <input type="number" id="estoqueMinimo" min="0" placeholder="10" value="5">
          </div>
          <div class="form-group">
            <label for="marcaProduto">Marca/Fabricante</label>
            <input type="text" id="marcaProduto" placeholder="Honda, Yamaha, etc.">
          </div>
          <div class="form-group">
            <label for="modeloProduto">Modelo Compat√≠vel</label>
            <input type="text" id="modeloProduto" placeholder="CG 160, Factor 125, etc.">
          </div>
        </div>
        
        <div class="form-group">
          <label for="descricaoProduto">Descri√ß√£o</label>
          <textarea id="descricaoProduto" placeholder="Descri√ß√£o detalhada da pe√ßa, compatibilidade, caracter√≠sticas especiais..."></textarea>
        </div>

        <!-- Preview -->
        <div class="product-preview" id="productPreview">
          <h3>üëÄ Preview do Produto</h3>
          <div class="preview-grid" id="previewGrid">
            <!-- Conte√∫do ser√° preenchido dinamicamente -->
          </div>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button type="submit" class="btn btn-success">
            üíæ Cadastrar Produto
          </button>
          <button type="button" class="btn btn-ghost" onclick="previewProduct()">
            üëÄ Visualizar
          </button>
          <button type="button" class="btn btn-danger" onclick="clearForm()">
            üóëÔ∏è Limpar Tudo
          </button>
        </div>
      </form>
    </section>
  </main>
</div>

<script>
  let stream = null;
  let isScanning = false;

  // Configura√ß√µes
  const API_BASE = '/api';

  // Fun√ß√£o para mostrar alertas
  function showAlert(message, type = 'info') {
    const alertContainer = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
      ${type === 'success' ? '‚úÖ' : type === 'danger' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'} ${message}
      <button onclick="this.parentElement.remove()" style="margin-left:auto; background:none; border:none; color:inherit; font-size:18px; cursor:pointer">&times;</button>
    `;
    alert.style.display = 'flex';
    alert.style.justifyContent = 'space-between';
    alert.style.alignItems = 'center';
    
    alertContainer.appendChild(alert);
    
    // Remover automaticamente ap√≥s 5 segundos
    setTimeout(() => {
      if (alert.parentElement) {
        alert.remove();
      }
    }, 5000);
  }

  // Iniciar c√¢mera para scanner
  async function startCamera() {
    try {
      const cameraSection = document.getElementById('cameraSection');
      const video = document.getElementById('video');
      
      // Solicitar acesso √† c√¢mera
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' } // C√¢mera traseira preferencialmente
      });
      
      video.srcObject = stream;
      cameraSection.classList.add('show');
      
      showAlert('C√¢mera ativada! Posicione o c√≥digo de barras na frente da c√¢mera', 'success');
      
      // Iniciar scanning autom√°tico
      isScanning = true;
      scanLoop();
      
    } catch (error) {
      console.error('Erro ao acessar c√¢mera:', error);
      showAlert('Erro ao acessar a c√¢mera. Verifique as permiss√µes ou digite o c√≥digo manualmente.', 'danger');
    }
  }

  // Parar c√¢mera
  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
    
    isScanning = false;
    document.getElementById('cameraSection').classList.remove('show');
    showAlert('C√¢mera desativada', 'info');
  }

  // Loop de scanning (simulado - em produ√ß√£o voc√™ usaria uma biblioteca como QuaggaJS)
  function scanLoop() {
    if (!isScanning) return;
    
    // Simular detec√ß√£o de c√≥digo de barras
    // Em produ√ß√£o, voc√™ integraria com uma biblioteca de detec√ß√£o real
    
    setTimeout(() => {
      if (isScanning) {
        scanLoop();
      }
    }, 100);
  }

  // Processar c√≥digo de barras (manual ou escaneado)
  async function processBarcode() {
    const barcodeInput = document.getElementById('barcodeInput');
    const code = barcodeInput.value.trim();
    
    if (!code) {
      showAlert('Digite um c√≥digo de barras primeiro!', 'warning');
      barcodeInput.focus();
      return;
    }

    // Validar formato b√°sico
    if (code.length < 8 || code.length > 20) {
      showAlert('C√≥digo de barras deve ter entre 8 e 20 caracteres', 'warning');
      barcodeInput.classList.add('error');
      return;
    }

    barcodeInput.classList.remove('error');
    barcodeInput.classList.add('success');

    // Mostrar loading
    const loading = document.getElementById('loading');
    loading.classList.add('show');

    try {
      // Primeiro, verificar se o produto j√° existe
      const existingProduct = await checkExistingProduct(code);
      
      setTimeout(() => {
        loading.classList.remove('show');
        
        if (existingProduct) {
          showAlert(`Produto j√° existe: ${existingProduct.name}. Deseja atualizar o estoque?`, 'warning');
          fillFormWithExisting(existingProduct);
        } else {
          // Produto n√£o existe, preparar para cadastro
          showAlert('C√≥digo de barras v√°lido! Preencha os dados do produto abaixo.', 'success');
          prepareNewProduct(code);
          
          // Focar no primeiro campo
          document.getElementById('codigoProduto').focus();
        }
        
        // Parar c√¢mera se estiver ativa
        if (isScanning) {
          stopCamera();
        }
      }, 1500);
      
    } catch (error) {
      loading.classList.remove('show');
      showAlert('Erro ao processar c√≥digo de barras: ' + error.message, 'danger');
      barcodeInput.classList.add('error');
    }
  }

  // Verificar se produto j√° existe no nosso sistema
  async function checkExistingProduct(code) {
    // DESABILITADO: N√£o tentar acessar API por enquanto
    console.log('üîç Verificando se produto existe (modo local)');
    
    // Simular que n√£o existe nenhum produto ainda
    // Em produ√ß√£o, aqui faria a busca real no banco
    return null;
    
    /*
    try {
      const response = await fetch(`${API_BASE}/produtos/buscar-codigo/${code}`);
      if (response.ok) {
        return await response.json();
      }
      return null;
    } catch (error) {
      console.log('Produto n√£o encontrado ou erro na API:', error);
      return null;
    }
    */
  }

  // Preparar formul√°rio para novo produto
  function prepareNewProduct(barcode) {
    // Gerar c√≥digo da pe√ßa automaticamente
    const productCode = generateProductCode();
    document.getElementById('codigoProduto').value = productCode;
    
    // Salvar c√≥digo de barras para uso posterior
    document.getElementById('productForm').dataset.barcode = barcode;
    
    // Ativar se√ß√£o do scanner
    document.getElementById('scannerSection').classList.add('active');
  }

  // Gerar c√≥digo de produto automaticamente
  function generateProductCode() {
    const prefix = 'MM-';
    const number = Math.floor(Math.random() * 9000) + 1000; // 1000-9999
    return prefix + number.toString().padStart(4, '0');
  }

  // Preencher formul√°rio com produto existente
  function fillFormWithExisting(product) {
    document.getElementById('codigoProduto').value = product.code || '';
    document.getElementById('nomeProduto').value = product.name || '';
    document.getElementById('tipoProduto').value = product.type || '';
    document.getElementById('precoProduto').value = product.price || '';
    document.getElementById('quantidadeProduto').value = product.stock || '';
    document.getElementById('marcaProduto').value = product.brand || '';
    document.getElementById('modeloProduto').value = product.model || '';
    document.getElementById('descricaoProduto').value = product.description || '';
  }

  // Visualizar produto
  function previewProduct() {
    const form = document.getElementById('productForm');
    const formData = new FormData(form);
    const preview = document.getElementById('productPreview');
    const previewGrid = document.getElementById('previewGrid');
    
    const data = {
      codigo: document.getElementById('codigoProduto').value,
      nome: document.getElementById('nomeProduto').value,
      tipo: document.getElementById('tipoProduto').value,
      preco: document.getElementById('precoProduto').value,
      quantidade: document.getElementById('quantidadeProduto').value,
      estoqueMinimo: document.getElementById('estoqueMinimo').value,
      marca: document.getElementById('marcaProduto').value,
      modelo: document.getElementById('modeloProduto').value,
      descricao: document.getElementById('descricaoProduto').value,
      codigoBarras: form.dataset.barcode
    };

    if (!data.codigo || !data.nome || !data.tipo || !data.preco) {
      showAlert('Preencha pelo menos os campos obrigat√≥rios (*) para visualizar', 'warning');
      return;
    }

    previewGrid.innerHTML = `
      <div class="preview-item">
        <div class="label">C√≥digo da Pe√ßa</div>
        <div class="value">${data.codigo}</div>
      </div>
      <div class="preview-item">
        <div class="label">Nome</div>
        <div class="value">${data.nome}</div>
      </div>
      <div class="preview-item">
        <div class="label">Tipo</div>
        <div class="value">${data.tipo}</div>
      </div>
      <div class="preview-item">
        <div class="label">Pre√ßo</div>
        <div class="value">R$ ${parseFloat(data.preco || 0).toFixed(2)}</div>
      </div>
      <div class="preview-item">
        <div class="label">Quantidade</div>
        <div class="value">${data.quantidade} unidades</div>
      </div>
      <div class="preview-item">
        <div class="label">C√≥digo de Barras</div>
        <div class="value">${data.codigoBarras || 'N√£o informado'}</div>
      </div>
      ${data.marca ? `
      <div class="preview-item">
        <div class="label">Marca</div>
        <div class="value">${data.marca}</div>
      </div>` : ''}
      ${data.modelo ? `
      <div class="preview-item">
        <div class="label">Modelo</div>
        <div class="value">${data.modelo}</div>
      </div>` : ''}
    `;

    preview.classList.add('show');
    preview.scrollIntoView({ behavior: 'smooth' });
    showAlert('Preview gerado! Confira os dados acima', 'success');
  }

  // Cadastrar produto
  async function cadastrarProduto(event) {
    event.preventDefault();
    
    const form = document.getElementById('productForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Validar campos obrigat√≥rios
    const requiredFields = form.querySelectorAll('input[required], select[required]');
    let hasError = false;
    
    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        field.style.borderColor = 'var(--danger)';
        hasError = true;
      } else {
        field.style.borderColor = '';
      }
    });
    
    if (hasError) {
      showAlert('Preencha todos os campos obrigat√≥rios (*)', 'warning');
      return;
    }

    // Preparar dados
    const productData = {
      codigo: document.getElementById('codigoProduto').value,
      nome: document.getElementById('nomeProduto').value,
      tipo: document.getElementById('tipoProduto').value,
      preco: parseFloat(document.getElementById('precoProduto').value),
      quantidade: parseInt(document.getElementById('quantidadeProduto').value),
      estoqueMinimo: parseInt(document.getElementById('estoqueMinimo').value) || 5,
      marca: document.getElementById('marcaProduto').value,
      modelo: document.getElementById('modeloProduto').value,
      descricao: document.getElementById('descricaoProduto').value,
      codigoBarras: form.dataset.barcode,
      datacriacao: new Date().toISOString()
    };

    // Mostrar loading no bot√£o
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<div class="spinner" style="width:16px;height:16px;margin-right:8px"></div> Cadastrando...';
    submitBtn.disabled = true;

    try {
      // Simular cadastro (substitua pela sua API real)
      await simulateCadastro(productData);
      
      // Sucesso
      showAlert('Produto cadastrado com sucesso! üéâ', 'success');
      
      // Limpar formul√°rio ap√≥s sucesso
      setTimeout(() => {
        clearForm();
        // Redirecionar para estoque ou mostrar op√ß√µes
        if (confirm('Produto cadastrado! Deseja cadastrar outro produto?')) {
          document.getElementById('barcodeInput').focus();
        } else {
          window.location.href = '/estoque.html';
        }
      }, 2000);
      
    } catch (error) {
      showAlert('Erro ao cadastrar produto: ' + error.message, 'danger');
    } finally {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  }

  // Simular cadastro (substitua pela sua API)
  async function simulateCadastro(data) {
    return new Promise((resolve, reject) => {
      setTimeout(() => {
        // Simular sucesso (90% de chance)
        if (Math.random() > 0.1) {
          console.log('Produto cadastrado:', data);
          
          // Salvar no localStorage para demonstra√ß√£o
          const produtos = JSON.parse(localStorage.getItem('produtos') || '[]');
          produtos.push({
            ...data,
            _id: Date.now().toString()
          });
          localStorage.setItem('produtos', JSON.stringify(produtos));
          
          resolve(data);
        } else {
          reject(new Error('Falha na comunica√ß√£o com servidor'));
        }
      }, 2000);
    });
  }

  // Limpar formul√°rio
  function clearForm() {
    const form = document.getElementById('productForm');
    form.reset();
    form.removeAttribute('data-barcode');
    
    // Limpar c√≥digo de barras
    const barcodeInput = document.getElementById('barcodeInput');
    barcodeInput.value = '';
    barcodeInput.classList.remove('success', 'error');
    
    // Esconder preview
    document.getElementById('productPreview').classList.remove('show');
    
    // Desativar scanner section
    document.getElementById('scannerSection').classList.remove('active');
    
    // Focar no campo de c√≥digo de barras novamente
    setTimeout(() => {
      barcodeInput.focus();
    }, 100);
    
    showAlert('Formul√°rio limpo! Pronto para pr√≥ximo produto', 'info');
  }

  // Event Listeners
  document.addEventListener('DOMContentLoaded', function() {
    // Form submit
    document.getElementById('productForm').addEventListener('submit', cadastrarProduto);
    
    // Enter no campo de c√≥digo de barras - processar automaticamente
    document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        processBarcode();
      }
    });

    // Detectar quando o leitor insere dados (detecta entrada r√°pida)
    let barcodeBuffer = '';
    let barcodeTimeout;
    
    document.getElementById('barcodeInput').addEventListener('input', function(e) {
      const currentValue = e.target.value;
      
      // Se mudou muito rapidamente (t√≠pico de scanner), processar automaticamente
      if (currentValue.length >= 8 && currentValue !== barcodeBuffer) {
        clearTimeout(barcodeTimeout);
        barcodeTimeout = setTimeout(() => {
          if (currentValue.length >= 8) {
            console.log('üì° Scanner detectado! Processando automaticamente...');
            processBarcode();
          }
        }, 100); // Delay pequeno para garantir que terminou de inserir
      }
      
      barcodeBuffer = currentValue;
    });

    // Auto-preview quando preencher campos
    const formFields = document.querySelectorAll('#productForm input, #productForm select, #productForm textarea');
    formFields.forEach(field => {
      field.addEventListener('change', function() {
        const codigo = document.getElementById('codigoProduto').value;
        const nome = document.getElementById('nomeProduto').value;
        if (codigo && nome) {
          previewProduct();
        }
      });
    });

    // Focar no input de c√≥digo de barras ao carregar
    setTimeout(() => {
      document.getElementById('barcodeInput').focus();
    }, 500);
    
    console.log('üì° Sistema otimizado para leitor de c√≥digo de barras f√≠sico!');
    showAlert('üîç Sistema pronto! Conecte seu leitor e escaneie um c√≥digo de barras', 'info');
  });

  // Atalhos de teclado otimizados para uso com scanner
  document.addEventListener('keydown', function(e) {
    // F1 = focar no c√≥digo de barras (atalho principal)
    if (e.key === 'F1') {
      e.preventDefault();
      focusBarcodeInput();
    }
    
    // Esc = limpar e voltar ao c√≥digo de barras
    if (e.key === 'Escape') {
      e.preventDefault();
      clearForm();
    }
    
    // Ctrl+S = cadastrar produto
    if (e.ctrlKey && e.key === 's') {
      e.preventDefault();
      const submitBtn = document.querySelector('button[type="submit"]');
      if (submitBtn && !submitBtn.disabled) {
        submitBtn.click();
      }
    }
    
    // Ctrl+P = preview
    if (e.ctrlKey && e.key === 'p') {
      e.preventDefault();
      previewProduct();
    }
    
    // Tab para navega√ß√£o mais fluida
    if (e.key === 'Tab' && document.activeElement === document.getElementById('barcodeInput')) {
      const value = document.getElementById('barcodeInput').value.trim();
      if (value.length >= 8) {
        e.preventDefault();
        processBarcode();
      }
    }
  });

  // Focar no campo de c√≥digo de barras
  function focusBarcodeInput() {
    const input = document.getElementById('barcodeInput');
    input.focus();
    input.select();
    showAlert('Campo focado! Use seu leitor de c√≥digo de barras agora', 'info');
  }

  console.log(`
üì° SISTEMA COM PREENCHIMENTO AUTOM√ÅTICO ATIVO!
=============================================

‚úÖ Funcionalidades:
‚Ä¢ Busca autom√°tica de informa√ß√µes por c√≥digo de barras
‚Ä¢ Preenchimento autom√°tico de: nome, pre√ßo, marca, modelo
‚Ä¢ Base de dados simulada de pe√ßas automotivas
‚Ä¢ Destaque visual dos campos preenchidos
‚Ä¢ Integra√ß√£o com APIs externas (configur√°vel)

üîç C√≥digos de Teste Dispon√≠veis:
‚Ä¢ 7891234567890 - Filtro de √ìleo Honda CG 160
‚Ä¢ 7891234567891 - Pastilha de Freio Yamaha Factor 125  
‚Ä¢ 7891234567892 - Vela de Igni√ß√£o NGK Honda CG
‚Ä¢ 7891234567893 - Corrente 428H Honda CB600
‚Ä¢ 7891234567894 - Amortecedor Traseiro Yamaha Fazer

üí° Como Funciona:
1. Escaneie/digite c√≥digo de barras
2. Sistema busca automaticamente as informa√ß√µes
3. Campos s√£o preenchidos com dados encontrados
4. Voc√™ s√≥ ajusta quantidade e confirma
5. Cadastro super r√°pido!

üîß Para Produ√ß√£o:
‚Ä¢ Integre com APIs de fornecedores reais
‚Ä¢ Conecte com bases de dados de pe√ßas
‚Ä¢ Configure mapeamento de c√≥digos espec√≠ficos
  `);

  // Adicionar mais c√≥digos de exemplo para teste
  const CODIGOS_TESTE = {
    '7891234567890': 'Filtro de √ìleo Honda CG 160 - Tecfil',
    '7891234567891': 'Pastilha de Freio Yamaha Factor 125 - Cobreq', 
    '7891234567892': 'Vela de Igni√ß√£o NGK Honda CG - NGK',
    '7891234567893': 'Corrente 428H Honda CB600 - RK',
    '7891234567894': 'Amortecedor Traseiro Yamaha Fazer - YSS',
    '1234567890123': 'Produto gen√©rico para teste',
    '9876543210987': 'Outra pe√ßa de teste'
  };

  // Mostrar c√≥digos dispon√≠veis para teste
  function mostrarCodigosTeste() {
    let message = 'üìã C√≥digos dispon√≠veis para teste:\n\n';
    Object.entries(CODIGOS_TESTE).forEach(([codigo, descricao]) => {
      message += `üîπ ${codigo} - ${descricao}\n`;
    });
    message += '\nüí° Use qualquer um destes c√≥digos para testar o preenchimento autom√°tico!';
    
    showAlert(message.replace(/\n/g, '<br>'), 'info');
  }

  // Adicionar bot√£o para mostrar c√≥digos de teste
  setTimeout(() => {
    const scannerSection = document.querySelector('.scanner-section');
    const testButton = document.createElement('button');
    testButton.className = 'btn btn-ghost';
    testButton.innerHTML = 'üìã Ver C√≥digos de Teste';
    testButton.onclick = mostrarCodigosTeste;
    testButton.style.marginTop = '10px';
    
    scannerSection.appendChild(testButton);
  }, 1000);

  // Valida√ß√£o em tempo real do c√≥digo de barras
  document.getElementById('barcodeInput').addEventListener('input', function(e) {
    const input = e.target;
    const value = input.value;
    
    // Remover classes anteriores
    input.classList.remove('success', 'error');
    
    if (value.length >= 8) {
      // Valida√ß√£o b√°sica do formato
      if (/^[0-9A-Z*\-]+$/.test(value)) {
        input.classList.add('success');
      } else {
        input.classList.add('error');
      }
    }
  });

  // Fun√ß√£o para gerar c√≥digo de produto inteligente baseado no tipo
  function generateSmartProductCode() {
    const tipo = document.getElementById('tipoProduto').value;
    const prefixMap = {
      'Motor': 'MT-',
      'Freio': 'FR-',
      'Suspensao': 'SP-',
      'Eletrica': 'EL-',
      'Carroceria': 'CR-',
      'Transmissao': 'TR-',
      'Outros': 'MM-'
    };
    
    const prefix = prefixMap[tipo] || 'MM-';
    const number = Math.floor(Math.random() * 9000) + 1000;
    return prefix + number.toString().padStart(4, '0');
  }

  // Atualizar c√≥digo quando trocar tipo
  document.getElementById('tipoProduto').addEventListener('change', function() {
    const codigoInput = document.getElementById('codigoProduto');
    if (!codigoInput.value || codigoInput.value.startsWith('MM-')) {
      codigoInput.value = generateSmartProductCode();
    }
  });

  console.log(`
üì± SISTEMA DE CADASTRO POR C√ìDIGO DE BARRAS
==========================================

‚úÖ Funcionalidades:
‚Ä¢ Scanner por c√¢mera
‚Ä¢ Entrada manual de c√≥digo
‚Ä¢ Valida√ß√£o em tempo real  
‚Ä¢ Preview do produto
‚Ä¢ Integra√ß√£o com API
‚Ä¢ Atalhos de teclado

üéØ Atalhos:
‚Ä¢ Enter: Processar c√≥digo de barras
‚Ä¢ Esc: Limpar formul√°rio
‚Ä¢ Ctrl+S: Cadastrar produto
‚Ä¢ Ctrl+P: Visualizar preview
‚Ä¢ F1: Focar no c√≥digo de barras

üì± Para usar scanner real:
Integre com bibliotecas como QuaggaJS ou ZXing
  `);

</script>
</body>
</html