<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <input id="scannerInput" autofocus style="opacity:0;position:absolute">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Milton Motos e Pe√ßas ‚Äî Estoque Avan√ßado</title>
  <meta name="description" content="Sistema de gest√£o de estoque avan√ßado ‚Äî Milton Motos e Pe√ßas" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Cores da marca */
      --brand-red: #C62828;
      --brand-blue: #0D47A1;
      --brand-white: #ffffff;
      --bg: #0f172a;          /* slate-900 */
      --panel: #111827;       /* gray-900 */
      --panel-2: #0b1220;     /* fundo cards */
      --muted: #94a3b8;       /* slate-400 */
      --text: #e5e7eb;        /* gray-200 */
      --ok: #16a34a;
      --warn: #f59e0b;
      --danger: #ef4444;
      --ring: 0 0 0 3px rgba(13,71,161,.3);
      --shadow-lg: 0 10px 30px rgba(0,0,0,.35);
      --shadow-md: 0 6px 18px rgba(0,0,0,.25);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-xl: 24px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 80% -10%, rgba(13,71,161,.25), transparent 40%),
                  radial-gradient(1000px 500px at -10% 20%, rgba(198,40,40,.25), transparent 45%),
                  var(--bg);
      color: var(--text);
      line-height:1.45;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a{color:inherit;text-decoration:none}
    button{font:inherit;cursor:pointer}

    .app{
      display:grid;
      grid-template-rows: auto 1fr;
      min-height:100dvh;
    }

    /* Header */
    .header{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(180deg, rgba(17,24,39,.9), rgba(17,24,39,.75));
      backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .header-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; gap:16px;
      padding:14px 20px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      font-weight:700; letter-spacing:.3px;
    }
    .logo{
      width:40px; height:40px; border-radius:12px; overflow:hidden;
      display:grid; place-items:center;
      background: linear-gradient(135deg, var(--brand-red), var(--brand-blue));
      box-shadow: var(--shadow-md);
    }
    .brand-title{font-size: clamp(16px, 2vw, 20px)}

    /* Nav */
    .nav{margin-left:auto; display:flex; align-items:center; gap:8px}
    .nav a{
      padding:10px 14px; border-radius:10px; color: var(--muted);
      transition: all 0.2s ease;
    }
    .nav a.active, .nav a:hover{color:var(--brand-white); background: rgba(255,255,255,.06)}

    .btn{cursor:pointer; border:0; border-radius:12px; padding:10px 14px; display:inline-flex; align-items:center; gap:8px; transition: all 0.2s ease}
    .btn-primary{background: linear-gradient(135deg, var(--brand-blue), #0b3c86); color:#fff; box-shadow: var(--shadow-md)}
    .btn-primary:hover{filter:brightness(1.05); transform: translateY(-1px)}
    .btn-ghost{background: transparent; color: var(--text)}
    .btn-ghost:hover{background: rgba(255,255,255,.06)}

    /* Layout */
    .container{max-width:1200px; margin:0 auto; padding:24px 20px}

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow-lg);
      border-radius: var(--radius);
      padding:18px;
    }

    /* Tabs Navigation */
    .tabs-nav{
      display:flex; gap:8px; margin-bottom:24px;
      background: var(--panel-2);
      padding:6px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.06);
      overflow-x:auto;
    }
    .tab-btn{
      background:transparent; color:var(--muted); border:0;
      padding:12px 18px; border-radius:10px; font-weight:500;
      white-space:nowrap; transition: all 0.2s ease;
      display:flex; align-items:center; gap:8px;
    }
    .tab-btn.active{
      background: linear-gradient(135deg, var(--brand-blue), #0b3c86);
      color:#fff; box-shadow: var(--shadow-md);
    }
    .tab-btn:hover:not(.active){
      color:var(--text); background: rgba(255,255,255,.06);
    }

    /* Tab Content */
    .tab-content{display:none; animation: fadeIn 0.3s ease}
    .tab-content.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* Hero Section */
    .hero{
      background: radial-gradient(800px 300px at 20% -30%, rgba(13,71,161,.25), transparent 40%),
                  radial-gradient(600px 260px at 100% 120%, rgba(198,40,40,.22), transparent 55%),
                  linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      border-radius: var(--radius);
      padding:24px;
      margin-bottom:24px;
      border:1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow-lg);
    }
    .hero h1{
      margin:8px 0 6px; font-size: clamp(24px, 3.4vw, 36px);
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-red));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .hero p{color: var(--muted); margin:0; font-size:16px}

    /* Form Grid */
    .form-grid{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
      gap:16px; margin-bottom:20px;
    }
    .form-group{display:flex; flex-direction:column; gap:6px}
    .form-group label{
      font-size:12px; color:var(--muted); text-transform:uppercase;
      letter-spacing:.08em; font-weight:600;
    }
    .form-group input, .form-group select{
      padding:12px 14px; border:1px solid rgba(255,255,255,.08);
      border-radius:10px; background:var(--panel-2); color:var(--text);
      transition: all 0.2s ease;
    }
    .form-group input:focus, .form-group select:focus{
      outline:0; border-color:var(--brand-blue);
      box-shadow: var(--ring);
    }

    /* Search */
    .search{
      display:flex; align-items:center; gap:10px; flex:1; min-width:220px;
      background: var(--panel-2); border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:10px 12px; margin-bottom:20px;
    }
    .search input{flex:1; background:transparent; border:0; outline:0; color:var(--text)}

    /* Table */
    .table-wrap{overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.06)}
    table{width:100%; border-collapse:collapse; min-width:760px; background: rgba(255,255,255,.02)}
    thead th{
      position:sticky; top:0; 
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      text-align:left; padding:12px; font-size:12px; text-transform:uppercase;
      letter-spacing:.08em; color:var(--muted); font-weight:600;
    }
    tbody td{padding:14px 12px; border-top:1px solid rgba(255,255,255,.06)}
    tbody tr:hover{background: rgba(255,255,255,.03)}

    /* Badges */
    .badge{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px;
      border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.12);
      font-weight:500;
    }
    .badge.blue{background:rgba(13,71,161,.12); color:var(--brand-blue)}
    .badge.red{background:rgba(198,40,40,.12); color:var(--brand-red)}
    .badge.green{background:rgba(22,163,74,.12); color:var(--ok)}
    .badge.yellow{background:rgba(245,158,11,.12); color:var(--warn)}

    /* Status Badges */
    .status-disponivel{background:rgba(22,163,74,.12); color:var(--ok)}
    .status-baixo{background:rgba(245,158,11,.12); color:var(--warn)}
    .status-esgotado{background:rgba(239,68,68,.12); color:var(--danger)}

    /* Code de Barras Display */
    .barcode-display{
      background: var(--panel-2);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:24px;
      text-align:center;
      margin:20px 0;
    }
    .barcode-number{
      font-family: 'Courier New', monospace;
      font-size:24px; font-weight:bold;
      color:var(--text); margin-bottom:12px;
    }
    .barcode-visual{
      font-family: 'Courier New', monospace;
      font-size:32px; color:var(--brand-blue);
      letter-spacing:2px; margin-bottom:16px;
    }

    /* KPIs */
    .kpis{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:24px}
    .kpi{
      padding:18px; border-radius:14px; background: var(--panel-2);
      border:1px solid rgba(255,255,255,.06);
    }
    .kpi .label{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em}
    .kpi .value{font-size: clamp(20px, 3vw, 28px); font-weight:700; margin-top:8px; color:var(--text)}
    .kpi .trend{font-size:12px; margin-top:8px}
    .trend.up{color:var(--ok)}
    .trend.down{color:var(--danger)}

    /* Alerts */
    .alert{
      padding:14px 16px; border-radius:12px; margin:16px 0;
      display:flex; align-items:center; gap:10px;
    }
    .alert-success{
      background:rgba(22,163,74,.1); border:1px solid rgba(22,163,74,.2);
      color:var(--ok);
    }
    .alert-warning{
      background:rgba(245,158,11,.1); border:1px solid rgba(245,158,11,.2);
      color:var(--warn);
    }
    .alert-danger{
      background:rgba(239,68,68,.1); border:1px solid rgba(239,68,68,.2);
      color:var(--danger);
    }

    /* Loading */
    .loading{
      text-align:center; padding:40px; color:var(--muted);
      font-style:italic;
    }

    /* Toolbar */
    .toolbar{
      display:flex; flex-wrap:wrap; gap:12px; align-items:center;
      justify-content:space-between; margin-bottom:20px;
    }

    /* Action Buttons */
    .actions{display:flex; gap:8px}
    .btn-sm{padding:8px 12px; font-size:12px; border-radius:8px}

    /* Acessibilidade */
    :is(a,button,input,select){outline:none}
    :is(a,button,input,select):focus-visible{box-shadow: var(--ring)}

    /* Responsive */
    @media (max-width:920px){
      .form-grid{grid-template-columns:1fr}
      .toolbar{flex-direction:column; align-items:stretch}
      .search{min-width:unset}
    }

    @media (max-width:640px){
      .container{padding:16px}
      .tabs-nav{flex-direction:column}
      .tab-btn{justify-content:center}
      .hero{padding:20px}
      .kpis{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="#fff" aria-hidden="true">
            <path d="M5 17h14l-1 3H6l-1-3Zm13.5-4c.83 0 1.5.67 1.5 1.5S19.33 16 18.5 16 17 15.33 17 14.5s.67-1.5 1.5-1.5ZM5.5 13c.83 0 1.5.67 1.5 1.5S6.33 16 5.5 16 4 15.33 4 14.5 4.67 13 5.5 13ZM3 6h9l3 3h6v5H3V6Z"/>
          </svg>
        </div>
        <span class="brand-title">Milton Motos e Pe√ßas</span>
      </div>

      <nav class="nav" aria-label="Navega√ß√£o principal">
        <a href="/">Dashboard</a>
        <a href="/produtos.html">Pe√ßas</a>
        <a href="/vendas.html">Vendas</a>
        <a href="#" class="active">Estoque</a>
        <button class="btn btn-ghost" title="Sair" aria-label="Sair">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M16 13v-2H7V8l-5 4 5 4v-3h9Z"/>
            <path d="M20 3h-8v2h8v14h-8v2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2Z"/>
          </svg>
          Sair
        </button>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="container">
    <!-- Hero Section -->
    <section class="hero">
      <h1>üèçÔ∏è Gest√£o de Estoque Avan√ßada</h1>
      <p>Sistema integrado com c√≥digo de barras, hist√≥rico de pre√ßos e sincroniza√ß√£o autom√°tica com fornecedores</p>
    </section>

    <!-- Tabs Navigation -->
    <nav class="tabs-nav" role="tablist">
      <button class="tab-btn active" role="tab" onclick="showTab('produtos')" aria-selected="true">
        üì¶ Produtos e C√≥digo de Barras
      </button>
      <button class="tab-btn" role="tab" onclick="showTab('precos')" aria-selected="false">
        üí∞ Hist√≥rico de Pre√ßos
      </button>
      <button class="tab-btn" role="tab" onclick="showTab('fornecedores')" aria-selected="false">
        üöö Fornecedores
      </button>
      <button class="tab-btn" role="tab" onclick="showTab('relatorios')" aria-selected="false">
        üìä Relat√≥rios
      </button>
    </nav>

    <!-- Tab: Produtos e C√≥digo de Barras -->
    <section id="produtos" class="tab-content active card" role="tabpanel">
      <h2 style="margin:0 0 20px; font-size:20px">üì¶ Produtos e C√≥digos de Barras</h2>
      
      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23 6.5 6.5 0 1 0-6.5 6.5 6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5Zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14Z"/>
        </svg>
        <input id="searchProdutos" type="search" placeholder="Buscar por nome, c√≥digo ou c√≥digo de barras..." aria-label="Buscar produto">
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="produtoSelect">Produto Existente</label>
          <select id="produtoSelect" onchange="carregarProdutoSelecionado()">
            <option value="">Selecione um produto...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="tipoCodigoBarras">Tipo de C√≥digo de Barras</label>
          <select id="tipoCodigoBarras">
            <option value="EAN13">EAN-13 (Padr√£o)</option>
            <option value="EAN8">EAN-8</option>
            <option value="CODE128">Code 128</option>
            <option value="CODE39">Code 39</option>
          </select>
        </div>
      </div>

      <div class="toolbar">
        <div style="display:flex; gap:12px">
          <button class="btn btn-primary" onclick="gerarCodigoBarras()">
            üìã Gerar C√≥digo de Barras
          </button>
          <button class="btn btn-ghost" onclick="buscarPorCodigo()">
            üîç Buscar por C√≥digo
          </button>
          <button class="btn btn-ghost" onclick="carregarProdutos()">
            üîÑ Atualizar Lista
          </button>
        </div>
      </div>

      <div id="codigoBarrasResult" style="display: none;" class="barcode-display">
        <div class="barcode-number" id="codigoNumero"></div>
        <div class="barcode-visual">||||| |||| | |||||||||</div>
        <button class="btn btn-ghost" onclick="imprimirCodigo()">
          üñ®Ô∏è Imprimir
        </button>
      </div>

      <div class="table-wrap" role="region" aria-label="Lista de produtos">
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Nome</th>
              <th>Tipo</th>
              <th>Pre√ßo</th>
              <th>Estoque</th>
              <th>Status</th>
              <th>C√≥digo de Barras</th>
              <th style="text-align:right">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="produtosTableBody">
            <tr>
              <td colspan="8" class="loading">üîÑ Carregando produtos...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Tab: Hist√≥rico de Pre√ßos -->
    <section id="precos" class="tab-content card" role="tabpanel">
      <h2 style="margin:0 0 20px; font-size:20px">üí∞ Hist√≥rico de Pre√ßos</h2>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="produtoPreco">Produto</label>
          <select id="produtoPreco" onchange="carregarHistoricoPrecos()">
            <option value="">Selecione um produto...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="novoPreco">Novo Pre√ßo (R$)</label>
          <input type="number" id="novoPreco" placeholder="0,00" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label for="motivoAlteracao">Motivo da Altera√ß√£o</label>
          <select id="motivoAlteracao">
            <option value="">Selecione o motivo...</option>
            <option value="promocao">Promo√ß√£o</option>
            <option value="ajuste_custo">Ajuste de Custo</option>
            <option value="concorrencia">Concorr√™ncia</option>
            <option value="sazonalidade">Sazonalidade</option>
            <option value="margem_lucro">Ajuste de Margem</option>
            <option value="outros">Outros</option>
          </select>
        </div>
        <div class="form-group">
          <label for="observacoesPreco">Observa√ß√µes</label>
          <input type="text" id="observacoesPreco" placeholder="Observa√ß√µes opcionais...">
        </div>
      </div>

      <button class="btn btn-primary" onclick="atualizarPreco()">
        üí∞ Atualizar Pre√ßo
      </button>

      <div style="margin-top:30px">
        <h3 style="margin-bottom:16px; font-size:16px">üìà Hist√≥rico de Altera√ß√µes</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Produto</th>
                <th>Pre√ßo Anterior</th>
                <th>Novo Pre√ßo</th>
                <th>Varia√ß√£o</th>
                <th>Motivo</th>
              </tr>
            </thead>
            <tbody id="historicoTableBody">
              <tr>
                <td colspan="6" class="loading">Selecione um produto para ver o hist√≥rico</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Tab: Fornecedores -->
    <section id="fornecedores" class="tab-content card" role="tabpanel">
      <h2 style="margin:0 0 20px; font-size:20px">üöö Integra√ß√£o com Fornecedores</h2>
      
      <div class="alert alert-warning">
        ‚ö†Ô∏è Esta funcionalidade requer configura√ß√£o t√©cnica. Entre em contato com o suporte para configurar integra√ß√µes autom√°ticas.
      </div>

      <div style="margin-top:20px">
        <h3 style="margin-bottom:16px; font-size:16px">Fornecedores Configurados</h3>
        <div id="fornecedoresList" class="loading">üîÑ Carregando integra√ß√µes...</div>
      </div>
    </section>

    <!-- Tab: Relat√≥rios -->
    <section id="relatorios" class="tab-content card" role="tabpanel">
      <h2 style="margin:0 0 20px; font-size:20px">üìä Relat√≥rios e Estat√≠sticas</h2>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="periodoRelatorio">Per√≠odo</label>
          <select id="periodoRelatorio">
            <option value="7">√öltimos 7 dias</option>
            <option value="30" selected>√öltimos 30 dias</option>
            <option value="90">√öltimos 90 dias</option>
          </select>
        </div>
      </div>

      <button class="btn btn-primary" onclick="gerarRelatorios()">
        üìä Gerar Relat√≥rios
      </button>

      <div id="relatoriosContent" style="margin-top:30px">
        <div class="loading">üìä Clique em "Gerar Relat√≥rios" para ver as estat√≠sticas</div>
      </div>
    </section>
  </main>
</div>

<script>
/* ===============================
   AUTH / SEGURAN√áA
================================ */
const token = localStorage.getItem('token');
if (!token) {
  window.location.href = 'login-cadastro.html';
}

/* ===============================
   CONFIG API
================================ */
const API_PRODUTOS = '/api/produtos';
const headersAuth = {
  'Content-Type': 'application/json',
  'Authorization': 'Bearer ' + token
};

/* ===============================
   ESTADO GLOBAL
================================ */
let produtosSistema = [];
let produtoSelecionado = null;
let historicoPrecos = [];

/* ===============================
   TABS
================================ */
function showTab(tabId, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.remove('active');
    b.setAttribute('aria-selected', 'false');
  });

  document.getElementById(tabId).classList.add('active');
  btn.classList.add('active');
  btn.setAttribute('aria-selected', 'true');
}

/* ===============================
   ALERTAS
================================ */
function mostrarAlerta(msg, tipo = 'success') {
  const div = document.createElement('div');
  div.className = `alert alert-${tipo}`;
  div.textContent = msg;

  document.querySelector('main').prepend(div);
  setTimeout(() => div.remove(), 4000);
}

/* ===============================
   PRODUTOS
================================ */
async function carregarProdutos() {
  try {
    const res = await fetch(API_PRODUTOS, { headers: headersAuth });
    if (!res.ok) throw new Error('Erro ao buscar produtos');

    produtosSistema = await res.json();
    atualizarTabelaProdutos();
    atualizarSelectProdutos();

  } catch (err) {
    console.error(err);
    mostrarAlerta('Erro ao carregar produtos', 'danger');
  }
}

function atualizarTabelaProdutos() {
  const tbody = document.getElementById('produtosTableBody');
  tbody.innerHTML = '';

  if (!produtosSistema.length) {
    tbody.innerHTML = '<tr><td colspan="8">Nenhum produto encontrado</td></tr>';
    return;
  }

  produtosSistema.forEach(p => {
    const estoque = Number(p.estoque || 0);

    let status = 'Esgotado';
    let statusClass = 'status-esgotado';

    if (estoque > 20) {
      status = 'Dispon√≠vel';
      statusClass = 'status-disponivel';
    } else if (estoque > 0) {
      status = 'Baixo';
      statusClass = 'status-baixo';
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.codigo || '-'}</td>
      <td>${p.nome}</td>
      <td>${p.tipo || '-'}</td>
      <td>R$ ${Number(p.preco || 0).toFixed(2)}</td>
      <td>${estoque}</td>
      <td><span class="badge ${statusClass}">${status}</span></td>
      <td>${p.codigoBarras || 'N√£o gerado'}</td>
      <td style="text-align:right">
        <button onclick="editarProduto('${p._id}')">‚úèÔ∏è</button>
        <button onclick="excluirProduto('${p._id}')">üóëÔ∏è</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ===============================
   SELECTS
================================ */
function atualizarSelectProdutos() {
  ['produtoSelect', 'produtoPreco'].forEach(id => {
    const select = document.getElementById(id);
    if (!select) return;

    select.innerHTML = '<option value="">Selecione...</option>';

    produtosSistema.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p._id;
      opt.textContent = `${p.codigo || '-'} - ${p.nome}`;
      select.appendChild(opt);
    });
  });
}

function carregarProdutoSelecionado() {
  const id = document.getElementById('produtoSelect').value;
  produtoSelecionado = produtosSistema.find(p => p._id === id) || null;
}

/* ===============================
   CRUD
================================ */
async function excluirProduto(id) {
  if (!confirm('Excluir este produto?')) return;

  await fetch(`${API_PRODUTOS}/${id}`, {
    method: 'DELETE',
    headers: headersAuth
  });

  carregarProdutos();
}

function editarProduto(id) {
  alert('Edi√ß√£o detalhada pode ser conectada ao modal futuramente');
}

/* ===============================
   C√ìDIGO DE BARRAS
================================ */
function gerarCodigoEAN13() {
  let base = '';
  for (let i = 0; i < 12; i++) base += Math.floor(Math.random() * 10);

  let soma = 0;
  for (let i = 0; i < 12; i++) {
    soma += base[i] * (i % 2 === 0 ? 1 : 3);
  }
  return base + ((10 - (soma % 10)) % 10);
}

async function gerarCodigoBarras() {
  if (!produtoSelecionado) {
    mostrarAlerta('Selecione um produto primeiro', 'warning');
    return;
  }

  const codigo = gerarCodigoEAN13();

  await fetch(`${API_PRODUTOS}/${produtoSelecionado._id}/codigo-barras`, {
    method: 'PUT',
    headers: headersAuth,
    body: JSON.stringify({ codigoBarras: codigo })
  });

  mostrarAlerta('C√≥digo de barras gerado');
  carregarProdutos();
}

/* ===============================
   PRE√áOS / HIST√ìRICO (SIMULADO)
================================ */
function atualizarPreco() {
  const id = document.getElementById('produtoPreco').value;
  const novoPreco = Number(document.getElementById('novoPreco').value);

  if (!id || !novoPreco) {
    mostrarAlerta('Preencha os campos', 'warning');
    return;
  }

  const p = produtosSistema.find(x => x._id === id);
  if (!p) return;

  historicoPrecos.unshift({
    produto: p.nome,
    anterior: p.preco,
    novo: novoPreco,
    data: new Date()
  });

  p.preco = novoPreco;
  atualizarTabelaProdutos();
  mostrarAlerta('Pre√ßo atualizado');
}

/* ===============================
   SEARCH
================================ */
document.getElementById('searchProdutos')?.addEventListener('input', e => {
  const termo = e.target.value.toLowerCase();
  document.querySelectorAll('#produtosTableBody tr').forEach(tr => {
    tr.style.display = tr.textContent.toLowerCase().includes(termo) ? '' : 'none';
  });
});

/* ===============================
   INIT
================================ */
document.addEventListener('DOMContentLoaded', () => {
  carregarProdutos();
});
</script>

<!-- Adicionar footer se necess√°rio -->
<footer style="color:var(--muted); text-align:center; padding:26px 16px; margin-top:40px">
  ¬© <span id="ano-footer"></span> Milton Motos e Pe√ßas ‚Äî Todos os direitos reservados.
</footer>

<script>
  // Preencher ano do footer
  document.getElementById('ano-footer').textContent = new Date().getFullYear();
</script>

</body>
</html>